<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hot Swap Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .log {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-size: 12px;
        }
        button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-family: inherit;
        }
        button:hover {
            background: #357abd;
        }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warning { color: #ffd43b; }
        .info { color: #74c0fc; }
        input {
            background: #333;
            color: #00ff00;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            font-family: inherit;
            width: 100%;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° Hot Swap Test</h1>
        
        <div class="section">
            <h2>Contact Key Management</h2>
            <input type="text" id="userId" placeholder="User ID (e.g., mattchristiansenresearch@gmail.com)" value="mattchristiansenresearch@gmail.com">
            <input type="text" id="publicKey" placeholder="Public Key (124 characters)" value="MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEQT03uDvkP592Ma+M7LBGdgfzgr+Z56tV1dye5A/53k5X54HnkI9Ig4hX5gmBk6mvZdy2a74B6KV+O6IgOtXXWQ==">
            <button onclick="hotSwapKey()">üîë Hot Swap Key</button>
            <button onclick="checkKey()">üîç Check Current Key</button>
            <button onclick="testECDH()">üß™ Test ECDH</button>
            <button onclick="sendTestMessage()">üì§ Send Test Message</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `[${timestamp}] <span class="${className}">${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function hotSwapKey() {
            const userId = document.getElementById('userId').value;
            const publicKey = document.getElementById('publicKey').value;
            
            if (!userId || !publicKey) {
                log('‚ùå Please enter both user ID and public key', 'error');
                return;
            }

            log(`üîë Hot swapping key for ${userId}...`);
            
            try {
                // Use the global utility function
                if (window.updateContactKey) {
                    await window.updateContactKey(userId, publicKey);
                    log(`‚úÖ Key hot-swapped successfully for ${userId}`, 'success');
                } else {
                    log('‚ùå Global utility not available - KeyManagementService not loaded', 'error');
                }
            } catch (error) {
                log(`‚ùå Hot swap failed: ${error.message}`, 'error');
            }
        }

        function checkKey() {
            const userId = document.getElementById('userId').value;
            
            if (!userId) {
                log('‚ùå Please enter a user ID', 'error');
                return;
            }

            log(`üîç Checking current key for ${userId}...`);
            
            try {
                if (window.getContactKey) {
                    const key = window.getContactKey(userId);
                    if (key) {
                        log(`‚úÖ Found key for ${userId}`, 'success');
                        log(`üîë Key length: ${key.length} characters`);
                        log(`üîë Key preview: ${key.substring(0, 50)}...`);
                    } else {
                        log(`‚ùå No key found for ${userId}`, 'error');
                    }
                } else {
                    log('‚ùå Global utility not available', 'error');
                }
            } catch (error) {
                log(`‚ùå Check failed: ${error.message}`, 'error');
            }
        }

        async function testECDH() {
            const userId = document.getElementById('userId').value;
            
            if (!userId) {
                log('‚ùå Please enter a user ID', 'error');
                return;
            }

            log(`üß™ Testing ECDH with ${userId}...`);
            
            try {
                if (window.testECDH) {
                    const result = await window.testECDH(userId);
                    if (result) {
                        log(`‚úÖ ECDH test successful for ${userId}`, 'success');
                        log(`üîê Shared secret: ${result.substring(0, 20)}...`);
                    } else {
                        log(`‚ùå ECDH test failed for ${userId}`, 'error');
                    }
                } else {
                    log('‚ùå Global utility not available', 'error');
                }
            } catch (error) {
                log(`‚ùå ECDH test failed: ${error.message}`, 'error');
            }
        }

        async function sendTestMessage() {
            const userId = document.getElementById('userId').value;
            
            if (!userId) {
                log('‚ùå Please enter a user ID', 'error');
                return;
            }

            log(`üì§ Sending test message to ${userId}...`);
            
            try {
                // This would require the WebSocket service to be available
                // For now, just log that we would send a message
                log(`üìù Would send message to ${userId} using hot-swapped key`, 'info');
                log(`üí° Try sending a message in the main app now - it should use the new key!`, 'success');
            } catch (error) {
                log(`‚ùå Send test failed: ${error.message}`, 'error');
            }
        }

        // Auto-run on load
        window.onload = function() {
            log('‚ö° Hot Swap Test Tool Ready');
            log('This tool demonstrates in-memory key hot-swapping');
            log('1. Enter user ID and public key');
            log('2. Click "Hot Swap Key" to update in memory');
            log('3. Click "Test ECDH" to verify it works');
            log('4. Send a message in the main app to test decryption');
            log('');
            log('üîß Global utilities should be available if KeyManagementService is loaded');
        };
    </script>
</body>
</html> 